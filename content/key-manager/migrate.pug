| <?xml version="1.0"?>
| <?xml-stylesheet href="chrome://global/skin/" type="text/css"?>
| <?xml-stylesheet href="chrome://zotero-platform/content/zotero.css"?>
| <?xml-stylesheet href="chrome://global/skin/global.css"?>
| <?xml-stylesheet href="chrome://zotero/skin/zotero.css"?>
| <?xml-stylesheet href="chrome://zotero-platform/content/overlay.css"?>
| <?xml-stylesheet href="chrome://zotero-better-bibtex/content/skin/preferences.css"?>
| <?xml-stylesheet href="chrome://zotero-better-bibtex/content/skin/error-report.css" type="text/css"?>
window(xmlns='http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul'
       xmlns:html='http://www.w3.org/1999/xhtml'
       title='Better BibTeX citation key migration'
       width='450' height='320'
       onload='init()')
  html:style.
    body {
      font: message-box;
      padding: 20px;
      background-color: Dialog;
      color: DialogText;
      line-height: 1.4;
    }
    .option-container {
      margin-top: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .footer {
      margin-top: 25px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    .divider {
      border-top: 1px solid #ccc;
      margin: 15px 0;
    }
    button[disabled] {
      color: #888 !important;
      background-color: #eee !important;
      cursor: not-allowed;
    }
    input[type='radio'] {
      margin-right: 8px;
      vertical-align: middle;
    }
    input[type='radio'] {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
  
      width: 14px;
      height: 14px;
      border: 1px solid #777; /* Visible border color */
      border-radius: 50%;
      background-color: #fff;
      cursor: pointer;
      position: relative;
      display: inline-block;
    }

    input[type='radio']:checked::before {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #007bff; /* Zotero blue */
    }

    label {
      cursor: pointer;
      display: flex;
      align-items: center;
    }

  html:body
    html:div#header(style='font-weight: bold; margin-bottom: 10px;')
      | You have {zotero} Zotero citation keys, and {total} Better BibTeX stored citation keys, of which {pinned} are pinned

    html:div
      | Zotero 8 adds a native citation key field, which replaces the Better BibTeX citation key field. Since you have existing Better BibTeX citation keys, do you want to:

    html:div.option-container
      html:label
        html:input(type='radio' name='migrate' value='all' onchange='migrate(this)')
        |  Migrate all Better BibTeX citation keys to Zotero citation keys

      html:label#pinned
        html:input(type='radio' name='migrate' value='pinned' onchange='migrate(this)')
        |  Migrate only pinned Better BibTeX citation keys to Zotero citation keys, and discard the dynamic (non-pinned) Better BibTeX citation keys

      html:label
        html:input(type='radio' name='migrate' value='none' onchange='migrate(this)')
        |  Discard all Better BibTeX citation keys

    html:div.divider

    html:div#header(style='font-weight: bold; margin-bottom: 10px;')
      | When a Better BibTeX stored citation key exists for an item that currently has a citation key in Zotero:

    html:div.option-container
      html:label
        html:input(type='radio' name='overwrite' value='yes' onchange='overwrite(this)')
        |  Overwrite existing key in the library
      html:label
        html:input(type='radio' name='overwrite' value='no' onchange='overwrite(this)')
        |  Discard Better BibTeX citation key
    html:div.divider

    html:div#header(style='font-weight: bold; margin-bottom: 10px;')
      | Do you want citation keys to update when you change the item?

    html:div.option-container
      html:label
        html:input(type='radio' name='dynamic' value='yes' onchange='dynamic(this)')
        |  Update citation keys when the item changes
      html:label
        html:input(type='radio' name='dynamic' value='no' onchange='dynamic(this)')
        |  Once set, keep the citation key unchanged

    html:div.divider
    html:div
      | If it is unclear to you what these choices means, just choose "ask me again" and ask for more information in the
      | discussion lists of Better BibTeX at https://tinyurl.com/key-migration. When choosing "ask me
    html:div
      | again", nothing happens, and you will be offered the same choice at next start. Note that until you migrate, the Better
      | BibTeX citation keys are unavailable.

    html:div.footer
      html:button#postpone(onclick='finish("postpone")') Do not migrate; ask me again at next start
      html:button#ok(disabled='true' style='font-weight: bold;' onclick='finish()') Migrate

  script(type='application/javascript').
    const choice = {}

    function gate() {
      const ok = document.getElementById('ok')

      document.querySelectorAll('input[type="radio"][name="overwrite"]').forEach(radio => {
        radio.disabled = choice.migrate === 'none'
      })

      const dynamic = typeof choice.dynamic === 'boolean'
      const overwrite = typeof choice.overwrite === 'boolean'
      switch (choice.migrate || '') {
        case '':
          ok.disabled = true
          break
        case 'none':
          ok.disabled = !dynamic
          break
        default:
          ok.disabled = !overwrite || !dynamic
          break
      }
    }

    function migrate(el) {
      choice.migrate = el.value
      gate()
    }

    function overwrite(el) {
      choice.overwrite = el.value === 'yes'
      gate()
    }

    function dynamic(el) {
      choice.dynamic = el.value === 'yes'
      gate()
    }
    function finish(val) {
      choice.migrate = val || choice.migrate
      Object.assign(window.arguments[0], choice)
      window.close()
    }
    function init() {
      window.sizeToContent()
      const params = window.arguments[0]
      if (!params.pinned) document.getElementById('pinned')?.style.setProperty('display', 'none')
      const header = document.getElementById('header')
      header.innerHTML = header.innerHTML.replace(/[{]([a-z]+)[}]/g, (_, p) => `${params[p]}`)
    }
